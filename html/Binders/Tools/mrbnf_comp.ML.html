<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/mrbnf_comp.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/mrbnf_comp.ML›</h1>
</div>

<pre class="source"><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>MRBNF_COMP</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> typedef_threshold</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> with_typedef_threshold</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> with_typedef_threshold_yield</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    'a * </span><span class="entity"><span>Proof.context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> as_mrbnf</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ID_mrbnf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> DEADID_mrbnf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>comp_cache</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>unfold_set</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>map_unfolds</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     set_unfoldss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     rel_unfolds</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty_comp_cache</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>comp_cache</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty_unfolds</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> BAD_DEAD </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mrbnf_of_typ</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>MRBNF_Def.inline_policy</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>MRBNF_Def.var_type</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> clean_compose_mrbnf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>MRBNF_Def.inline_policy</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> permute_mrbnf</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> normalize_mrbnfs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>MRBNF_Def.var_type</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span>  </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>int</span><span> </span><span>list</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> </span><span>option</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> compose_mrbnf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>MRBNF_Def.inline_policy</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>MRBNF_Def.var_type</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>comp_cache</span></span><span> * </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>absT_info</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>absT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
     repT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
     abs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     rep</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     abs_inject</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     abs_inverse</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     type_definition</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> morph_absT_info</span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>absT_info</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>absT_info</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_absT</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_repT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_abs</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_rep</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> seal_mrbnf</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>MRBNF_Def.mrbnf</span></span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span class="entity"><span>absT_info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>MRBNF_Comp</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>MRBNF_COMP</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>MRBNF_Def</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>MRBNF_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Tactics</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Comp_Tactics</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>MRBNF_Comp_Tactics</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typedef_threshold</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="MRBNF_Composition.mrbnf_typedef_threshold|attribute"><span>mrbnf_typedef_threshold</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>6</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_typedef_threshold</span></span><span> </span><span class="entity"><span>threshold</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>lthy</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>typedef_threshold</span></span><span> </span><span class="entity"><span>threshold</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>typedef_threshold</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>typedef_threshold</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_typedef_threshold_yield</span></span><span> </span><span class="entity"><span>threshold</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>lthy</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>typedef_threshold</span></span><span> </span><span class="entity"><span>threshold</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span>||&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>typedef_threshold</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>typedef_threshold</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ID_mrbnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="inner_quoted"><span>"BNF_Composition.ID"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>DEADID_mrbnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="inner_quoted"><span>"BNF_Composition.DEADID"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>comp_cache</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>Typtab.table</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_typess</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key_of_types</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typ_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>key_of_typess</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>T_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lives_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frees_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bounds_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span>sort</span><span> </span><span>Term_Ord.typ_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typ_of_var_type</span></span><span> </span><span class="entity"><span>MRBNF_Def.Live_Var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Live_Var"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>typ_of_var_type</span></span><span> </span><span class="entity"><span>MRBNF_Def.Free_Var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Free_Var"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>typ_of_var_type</span></span><span> </span><span class="entity"><span>MRBNF_Def.Bound_Var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bound_Var"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>typ_of_var_type</span></span><span> </span><span class="entity"><span>MRBNF_Def.Dead_Var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Dead_Var"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_demote</span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="inner_quoted"><span>"d"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>typ_of_var_type</span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>typ_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_lift</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="inner_quoted"><span>"l+"</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_permute</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="inner_quoted"><span>"p"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="entity"><span>typ_of_int</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>typ_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_compose</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>oAs</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>key_of_types</span></span><span> </span><span class="inner_quoted"><span>"c"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key_of_typess</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>oDs</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Dss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>oAs</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ass</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>map</span><span> </span><span class="entity"><span>typ_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outer</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cache_comp_simple</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Typtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cache_comp</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf_Ds_As</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf_Ds_As</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Typtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mrbnf_Ds_As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>unfold_set</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  map_unfolds</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  set_unfoldss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  rel_unfolds</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>as_mrbnf</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mrbnf_of</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>BNF_Def.bnf_of</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_bnf_as_mrbnf</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_comp_cache</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Typtab.empty</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_unfolds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>map_unfolds </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> set_unfoldss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> rel_unfolds </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_to_thms</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Thm.is_reflexive</span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>insert</span><span> </span><span>Thm.eq_thm</span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adds_to_thms</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>news</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span>eq_set</span><span> </span><span>Thm.eq_thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no_reflexive</span></span><span> </span><span class="entity"><span>news</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_to_unfolds</span></span><span> </span><span class="entity"><span>map</span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>rel</span></span><span>
  </span><span class="main"><span>{</span></span><span class="entity"><span>map_unfolds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set_unfoldss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_unfolds</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>map_unfolds </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_to_thms</span></span><span> </span><span class="entity"><span>map_unfolds</span></span><span> </span><span class="entity"><span>map</span></span><span class="main"><span>,</span></span><span>
    set_unfoldss </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>adds_to_thms</span></span><span> </span><span class="entity"><span>set_unfoldss</span></span><span> </span><span class="entity"><span>sets</span></span><span class="main"><span>,</span></span><span>
    rel_unfolds </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_to_thms</span></span><span> </span><span class="entity"><span>rel_unfolds</span></span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_mrbnf_to_unfolds</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>add_to_unfolds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_def_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_defs_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_def_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bdTN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"bdT"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_killN</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_kill"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_liftN</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_lift"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n2</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_permuteN</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="inner_quoted"><span>"_permute_"</span></span><span> </span><span>^</span><span> </span><span>implode</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>implode</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*copied from Envir.expand_term_free*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_term_const</span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>dest_Const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Envir.expand_term</span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id_mrbnf_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.id_bnf_def|fact"><span>BNF_Composition.id_bnf_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expand_id_mrbnf_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>expand_term_const</span></span><span> </span><span class="main"><span>[</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>id_mrbnf_def</span></span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_equals</span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.csum|const"><span>BNF_Cardinal_Arithmetic.csum</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.cprod|const"><span>BNF_Cardinal_Arithmetic.cprod</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>aconv</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Order_Relation.html#BNF_Cardinal_Order_Relation.natLeq|const"><span>natLeq</span></a></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*
 * Instantiates the live variables of an outer MRBNF with several inner MRBNFs and returns a composed MRBNF.
 * The composed MRBNF will have:
 *   - The union of the dead variables of the outer and the inner MRBNFs
 *   - The live variables of the inner MRBNFs (which are the same for all inner MRBNFs by invariant)
 *   - The free and bound variables of the outer MRBNF (which are the same as those of all inner MRBNFs by invariant)
 *
 * INVARIANTS:
 *   - All inner MRBNFs have the same live variables in the same order
 *   - Outer and all inner MRBNFs have the same bound and free variables in the same order (the live variables are ignored while checking the order)
 *   - There are as many inner MRBNFs as there are live variables on the outer MRBNF
 *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clean_compose_mrbnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_ilives</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_olives</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_free</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>free_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_bound</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_inondead</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>num_ilives</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>num_free</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>num_bound</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_onondead</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>num_free</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>num_bound</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ivar_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ovar_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_ilive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_olive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ovar_types</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span>Sign.inter_sort</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>class_of_mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cosort</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span>Sign.inter_sort</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>coclass_of_mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>coclass_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_unprefix</span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="entity"><span>prfx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_class</span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span>^</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>try_unprefix</span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>short_type_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Local_Theory.background_theory_result</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Class_Declaration.class</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thy</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>class</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>Local_Theory.exit_global</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coclass</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_class</span></span><span> </span><span class="inner_quoted"><span>"var_"</span></span><span> </span><span class="entity"><span>sort</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_class</span></span><span> </span><span class="inner_quoted"><span>"covar_"</span></span><span> </span><span class="entity"><span>cosort</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>oDs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iDss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span>o</span><span> </span><span class="entity"><span>deads_of_mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_TFrees</span></span><span> </span><span class="entity"><span>num_ilives</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_TFrees</span></span><span> </span><span class="entity"><span>num_ilives</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>free_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* Create the types of the inners, the only thing that is not the same by invariant are the dead variables.
     * This is dones once for the As and once for the As' of the live variables *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_T_of_mrbnf</span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>iDss</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iTs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_T_of_mrbnf</span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>iDss</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* Create the type of the outer, this will replace the live variables of the outer with the types of the inners *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_mrbnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>iTs</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* Create the composed bound (bd) for the new MRBNF: bd = (inner_1.bd +c inner_2.bd +c ... +c inner_m.bd) *c outer.bd *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>BNF_Util.mk_cprod</span></span><span> </span><span class="main"><span>(</span></span><span>foldr1</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>BNF_Util.mk_csum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>bd_of_mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>

    </span><span class="comment1"><span>(* In case the composed bound only consists of sums and products of "natLeq", simplify the bound to just "natLeq" *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_ordIso_natLeq_thm_opt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_sum_prod_natLeq</span></span><span> </span><span class="entity"><span>bd</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Order_Relation.html#BNF_Cardinal_Order_Relation.natLeq|const"><span>natLeq</span></a></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_bd'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ordIso</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Wellorder_Constructions.html#BNF_Wellorder_Constructions.ordIso|const"><span>ordIso</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>bd_bd'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>BNF_Util.mk_Trueprop_mem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_bd'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ordIso</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd'</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_Comp_Tactics.bd_ordIso_natLeq_tac</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>context</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mr_mk_comp_map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_id0_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>map_id0_of_mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mr_mk_comp_map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_comp0_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>map_comp0_of_mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mr_mk_comp_bd_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_of_mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_infinite_regular_card_order_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_sets_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_onondead</span></span><span> </span><span class="entity"><span>oDs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_onondead</span></span><span> </span><span class="entity"><span>iTs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_onondead</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_onondead</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_setss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_sets_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_inondead</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_inondead</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_inondead</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_inondead</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>iDss</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sets</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sets_alt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ivars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>interlace</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_outer_sets'</span></span><span> </span><span class="entity"><span>osets</span></span><span> </span><span class="entity"><span>ovar_types</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_outer_sets'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>osets</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Live_Var</span></span><span>::</span><span class="entity"><span>ovar_types</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_outer_sets'</span></span><span> </span><span class="entity"><span>osets</span></span><span> </span><span class="entity"><span>ovar_types</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_outer_sets'</span></span><span> </span><span class="entity"><span>osets</span></span><span> </span><span class="entity"><span>ovar_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Live_Var</span></span><span>::</span><span class="entity"><span>ivar_types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>::</span><span class="entity"><span>mk_outer_sets'</span></span><span> </span><span class="entity"><span>osets</span></span><span> </span><span class="entity"><span>ovar_types</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_outer_sets'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span>::</span><span class="entity"><span>osets</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>ovar_types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>ivar_types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span>::</span><span class="entity"><span>mk_outer_sets'</span></span><span> </span><span class="entity"><span>osets</span></span><span> </span><span class="entity"><span>ovar_types</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_sets'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_outer_sets'</span></span><span> </span><span class="entity"><span>outer_sets</span></span><span> </span><span class="entity"><span>ovar_types</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_set</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_type</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_olives</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ovar_types</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_olive_sets</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>filter_olives</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_sets_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_onondead</span></span><span> </span><span class="entity"><span>oDs</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_onondead</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_onondead</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_onondead</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ilive_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inner_setss</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_inner_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span>
              </span><span class="entity"><span>mk_map_of_mrbnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>iTs</span></span><span> </span><span class="entity"><span>setTs</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>interlace</span></span><span> </span><span class="entity"><span>ilive_sets</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.id_const</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.id_const</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ovar_types</span></span><span>
            </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>collect_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_collect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_olive_sets</span></span><span> </span><span class="entity"><span>setTs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_T_of_mrbnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>setTs</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>union_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Union</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_map</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_inner_sets</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compose_inner_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oset</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_image</span></span><span> </span><span class="entity"><span>iset</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>oset</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_olive_sets</span></span><span> </span><span class="entity"><span>iTs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ilive_sets</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>collect_compose</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_collect</span></span><span> </span><span class="entity"><span>compose_inner_sets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>union_compose</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Union</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>collect_compose</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux_mk_set</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.absdummy</span><span> </span><span class="entity"><span>oT</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>var_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="entity"><span>Live_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>u</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_union</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>outer_sets'</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aux_mk_set</span></span><span> </span><span class="entity"><span>union_map</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aux_mk_set</span></span><span> </span><span class="entity"><span>union_compose</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map_split</span><span> </span><span class="entity"><span>mk_set</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>num_inondead</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ivars</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_simplified_set</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_set'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.id_bnf|const"><span>BNF_Composition.id_bnf</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>setT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>setT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>setT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_set'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>mk_simplified_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_set_map_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set'_eq_set</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Goal.prove</span><span> </span><span class="entity"><span>names_lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>tac</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>set'_eq_set</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>set'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set'_eq_set</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sets'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_split</span><span> </span><span class="entity"><span>mk_simplified_set</span></span><span> </span><span class="entity"><span>sets</span></span><span>
      </span><span>||&gt;</span><span> </span><span>Proof_Context.export</span><span> </span><span class="entity"><span>names_lthy</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_single_set_map0_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mr_mk_comp_set_map0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_comp0_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>set_map0_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>set_map0_of_mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>ovar_types</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_single_set_map0_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>num_inondead</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_alt_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>quick_and_dirty</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>mr_mk_comp_set_alt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_map_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span> </span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>sets_alt</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cond_automap</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>fun_cong</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>is_ilive</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mr_mk_comp_map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span> </span><span class="entity"><span>set_alt_thms</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>map_cong0_of_mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>mr_mk_comp_set_bd_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bd_ordIso_natLeq_thm_opt</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>num_inondead</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*copied from BNF_Comp_Tactics*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>comp_in_alt_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.o_apply|fact"><span>o_apply</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Def.html#BNF_Def.collect_def|fact"><span>collect_def</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.image_insert|fact"><span>image_insert</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.image_empty|fact"><span>image_empty</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Complete_Lattices.html#Complete_Lattices.Union_insert|fact"><span>Union_insert</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Complete_Lattices.html#Complete_Lattices.UN_insert|fact"><span>UN_insert</span></a><span>
      </span><a class="entity_ref" href="../../../../../../HOL/HOL/Complete_Lattices.html#Complete_Lattices.UN_empty|fact"><span>UN_empty</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Complete_Lattices.html#Complete_Lattices.Union_empty|fact"><span>Union_empty</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.Un_empty_right|fact"><span>Un_empty_right</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Complete_Lattices.html#Complete_Lattices.Union_Un_distrib|fact"><span>Union_Un_distrib</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.Un_subset_iff|fact"><span>Un_subset_iff</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.conj_subset_def|fact"><span>conj_subset_def</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.UN_image_subset|fact"><span>UN_image_subset</span></a><span>
      </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.conj_assoc|fact"><span>conj_assoc</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*copied from BNF_Comp_Tactics*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_comp_in_alt_tac'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>comp_set_alts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>comp_set_alts</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>comp_in_alt_thms</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.set_eq_subset|fact"><span>set_eq_subset</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conjI</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
      </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.subsetI|fact"><span>subsetI</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
        </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.mem_Collect_eq|fact"><span>mem_Collect_eq</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.Ball_def|fact"><span>Ball_def</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN</span><span>
        </span><span class="main"><span>(</span></span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>CHANGED</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>etac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conjE</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
         </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>CHANGED</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conjI</span></span><span> </span><span>THEN'</span><span> </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>subset_UNIV</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>ORELSE'</span><span>
           </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>subset_UNIV</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>ORELSE</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>subset_UNIV</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>in_alt_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Asets</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>is_ilive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>oT</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iterms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>Asets</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>is_ilive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inner_setss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>iTs</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>iterms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>outer_sets</span></span><span> </span><span class="entity"><span>is_olive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>oT</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_comp_in_alt_tac'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>set_alt_thms</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le_rel_OO_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_mono_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>le_rel_OO_of_mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mr_mk_rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Def.html#BNF_Def.Ball_Collect|fact"><span>Ball_Collect</span></a><span class="antiquote"><span>}</span></span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pred_cong0_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span>OF</span><span> </span><span>map</span><span> </span><span class="entity"><span>pred_set_of_mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pred_set_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.Collect_inj|fact"><span>Collect_inj</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.UNIV_def|fact"><span>Set.UNIV_def</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span class="main"><span>]</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.Collect_inj|fact"><span>Collect_inj</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.UNIV_def|fact"><span>Set.UNIV_def</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>thm</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.in_alt_top|fact"><span>in_alt_top</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Def.html#BNF_Def.Ball_Collect|fact"><span>Ball_Collect</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
        </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pred_alt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_owits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nwits_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outer_wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_wits_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_owits</span></span><span> </span><span class="entity"><span>oDs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_owits</span></span><span> </span><span class="entity"><span>iTs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_owits</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>num_owits</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_witss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>I</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wit</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>I</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_wits_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>iDss</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>nwits_of_mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_witsss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>inner_witss</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer_wits</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inner_witsss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>outer_wits</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|-&gt;</span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>map_product</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>iwit</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>owit</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>owit</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>iwit</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>flat</span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.add_frees</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>minimize_wits</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span>absfree</span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mr_mk_comp_wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>set'_eq_sets</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* Define the map function of the composed MRBNF. It instantiates the map function of outer with the map functions of the inners:
     * ∀f1 ... fn v1 ... vm u1 ... ul. outer.map (inner_1.map f1 ... fn v1 ... vm u1 ... ul) ... (inner_m.map f1 ... fn v1 ... vm u1 ... ul) v1 ... vm u1 ... ul
     * Although in the example above the map function first takes all of the live variable functions, then all the bound variable function and
     * lastly the free variable functions, this does NOT have to be the case. Lives, bounds and frees can be interleaved in any order.
     * Additionally, the inners are only instanciated as the live variables of the outer, so the map function retains the functions for bounds and frees *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mapx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="comment1"><span>(* Create new variables for the different variable kinds and give them the types:
         *  - live: f1 ... fn : As<span class="hidden">⇩</span><sub>i</sub> ⇒ As'<span class="hidden">⇩</span><sub>i</sub>
         *  - bound: v1 ... vm : Bs<span class="hidden">⇩</span><sub>j</sub> ⇒ Bs<span class="hidden">⇩</span><sub>j</sub>
         *  - free: u1 ... ul : Fs<span class="hidden">⇩</span><sub>k</sub> ⇒ Fs<span class="hidden">⇩</span><sub>k</sub> *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span>
          </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>BNF_Util.mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>BNF_Util.mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"v"</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>BNF_Util.mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"u"</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fn_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>interlace</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span class="main"><span>;</span></span><span>

        </span><span class="comment1"><span>(* Create a list of the de Bruijn indices of the forall-bound function variables, and one list with only the frees and bounds *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fn_vars_ids</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_inondead</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fn_bounds_frees_ids</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fn_vars_ids</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ivar_types</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

        </span><span class="comment1"><span>(* As the forall-bound function variables over live, bound and free variables are already in the correct order,
         * the inner maps can be applied directly to those function variables *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>innermaps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>inner</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_mrbnf</span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>inner</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fn_vars_ids</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>iDss</span></span><span> </span><span class="entity"><span>inners</span></span><span>

        </span><span class="comment1"><span>(* The outer map function needs to be applied with the inner map functions for all its live variable functions,
         * and with the forall-bound bound and free variable function variables in the correct order.
         * For this, we need to interlace the inner map function with the function variables according to the variable types of the outer *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>interlace_maps</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>interlace_maps</span></span><span> </span><span class="entity"><span>ids</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span>::</span><span class="entity"><span>maps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Live_Var</span></span><span>::</span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>interlace_maps</span></span><span> </span><span class="entity"><span>ids</span></span><span> </span><span class="entity"><span>maps</span></span><span> </span><span class="entity"><span>ts</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>interlace_maps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>::</span><span class="entity"><span>ids</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>maps</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>interlace_maps</span></span><span> </span><span class="entity"><span>ids</span></span><span> </span><span class="entity"><span>maps</span></span><span> </span><span class="entity"><span>ts</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_mrbnf</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>iTs</span></span><span> </span><span class="entity"><span>iTs'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>interlace_maps</span></span><span> </span><span class="entity"><span>fn_bounds_frees_ids</span></span><span> </span><span class="entity"><span>innermaps</span></span><span> </span><span class="entity"><span>ovar_types</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>fn_vars</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* The relator for the composed MRBNF just instantiates the variables of the outer relator with the relators of the inners
     * ∀Q1 ... Qn. outer.rel (inner1.rel Q1 ... Qn) ... (innerm.rel Q1 ... Qn)
     * The same happens for the predicator *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="comment1"><span>(* Invent new variable names for relator and predicator prop variables *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span>
          </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>BNF_Util.mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"Q"</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>BNF_Util.mk_pred2T</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>BNF_Util.mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>BNF_Util.mk_pred1T</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="comment1"><span>(* Contrary to "map" the relator/predicator only works over the live variables, so no interlacing needed here *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_innerf</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>inner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>inner</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_ilives</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_f</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>iTs</span></span><span> </span><span class="entity"><span>iTs'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>,</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_innerf</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>iDss</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_f</span></span><span> </span><span class="entity"><span>mk_rel_of_mrbnf</span></span><span> </span><span class="entity"><span>Qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_f</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pred_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
      map_id0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span class="main"><span>,</span></span><span>
      map_comp0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span class="main"><span>,</span></span><span>
      map_cong0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span class="main"><span>,</span></span><span>
      set_map0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span class="main"><span>,</span></span><span>
      infinite_regular_card_order </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_tac</span></span><span class="main"><span>,</span></span><span>
      set_bd </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span class="main"><span>,</span></span><span>
      le_rel_OO </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span class="main"><span>,</span></span><span>
      in_rel </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span class="main"><span>,</span></span><span>
      pred_set </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span class="main"><span>,</span></span><span>
      wit </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span>
    </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ifco</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_of_mrbnf</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_UNIV</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span>Name.aT</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_card_of</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_ordLeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_card_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Field</span></span><span> </span><span class="entity"><span>bd'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>large</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>var_large </span><span>o</span><span> </span><span class="entity"><span>class_thms_of_mrbnf</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>var_goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>context</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>mr_mk_bd_card_leq_UNIV_tac</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ifco</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>ifco</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>large</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>large</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bd_ordIso_natLeq_thm_opt</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>zs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"z"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Fs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_covar_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>coclass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>covar_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_UNIV</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span>Name.aT</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coclass</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_card_of</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_ordLeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_LFP_Util.mk_cardSuc</span></span><span> </span><span class="entity"><span>bd'</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>large</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>covar_large  </span><span>o</span><span> </span><span class="entity"><span>class_thms_of_mrbnf</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>covar_goal</span></span><span> </span><span class="comment1"><span>(*(fold_rev Logic.all zs covar_goal)*)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>context</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>mr_mk_bd_cardSuc_leq_UNIV_tac</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ifco</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>ifco</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>large</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>large</span></span><span> </span><span class="entity"><span>inners</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bd_ordIso_natLeq_thm_opt</span></span><span>
          </span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_regular_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>coclass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_covar_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mrbnf_def</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Dont_Note</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oDs</span></span><span> </span><span>@</span><span> </span><span>flat</span><span> </span><span class="entity"><span>iDss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>class_thms</span></span><span class="main"><span>)</span></span><span>
              </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>oT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mapx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ivar_types</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>sets'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Morphism.thm_morphism</span><span> </span><span class="inner_quoted"><span>"MRBNF"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>id_mrbnf_def</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>$&gt;</span><span> </span><span>Morphism.term_morphism</span><span> </span><span class="inner_quoted"><span>"MRBNF"</span></span><span> </span><span class="entity"><span>expand_id_mrbnf_def</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>morph_mrbnf</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_mrbnf_to_unfolds</span></span><span> </span><span class="entity"><span>mrbnf'</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_simple_class_opt</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_thms_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>class_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>var_large </span><span class="entity"><span>class_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>var_regular </span><span class="entity"><span>class_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>coclass_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>covar_large </span><span class="entity"><span>class_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Changing the order of live, free and bound variables *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_permute_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_permuteN</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>free_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>free</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>bound</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frees_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nwits_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coclass</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coclass_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span>

    </span><span class="comment1"><span>(*create permutation shorthands*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*create shorthands for permutations of only live variables*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>src_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>is_live</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>src_live</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_live_perm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>is_live</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>permute_live</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>src_live</span></span><span> </span><span class="entity"><span>dest_live</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpermute_live</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dest_live</span></span><span> </span><span class="entity"><span>src_live</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>deads</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_TFrees</span></span><span> </span><span class="entity"><span>live</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_TFrees</span></span><span> </span><span class="entity"><span>live</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>bound</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>free</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*Construct mrbnf's set functions*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_sets_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_type_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>sets</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*Get types of lives, bounds and frees via image of set functions (not permuted)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ABF_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_setT</span></span><span> </span><span>o</span><span> </span><span>range_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>A'BF_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_setT</span></span><span> </span><span>o</span><span> </span><span>range_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_sets_of_mrbnf</span></span><span>
      </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*Create term list of permuted sets*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ABFsets</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>ABF_types</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(*Create map functions permutation as lambda term*)</span></span><span>
    </span><span class="comment1"><span>(*%f(1) ... f(n). mrbnf.map fσ(1) ... fσ(n)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mapx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ABF_types</span></span><span> </span><span class="entity"><span>A'BF_types</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span>  </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>count</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*Create relator permutation as lambda term*)</span></span><span>
    </span><span class="comment1"><span>(*%Q(1) ... Q(n). mrbnf.rel Qσ(1) ... Qσ(n)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute_live</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>mk_pred2T</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rel_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unpermute_live</span></span><span> </span><span class="comment1"><span>(*shorter permutation*)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(*%P(1) ... P(n). mrbnf.pred Pσ(1) ... Pσ(n)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute_live</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_pred1T</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*As or ABFs?, short or long permuation*)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pred_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unpermute_live</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="comment1"><span>(*temporary*)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="comment1"><span>(*use shorter permutation*)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bd_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*Proof obligations*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_id0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_comp0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span>THEN</span><span> </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span>THEN</span><span> </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span>FIRST'</span><span> </span><span class="main"><span>[</span></span><span>
        </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.supp_id_bound|fact"><span>supp_id_bound</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.bij_id|fact"><span>bij_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>etac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.emptyE|fact"><span>emptyE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
        </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
        </span><span>Goal.assume_rule_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_map0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_infinite_regular_card_order_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_bd_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt_thm_opt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>ABFsets</span></span><span> </span><span class="entity"><span>is_live_perm</span></span><span> </span><span class="comment1"><span>(*ABFsets are already permuted*)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="entity"><span>is_live_perm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unpermute_live</span></span><span> </span><span class="entity"><span>Asets</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span> </span><span class="entity"><span>is_live</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>NONE</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>mk_permute_in_alt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>src_live</span></span><span> </span><span class="entity"><span>dest_live</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le_rel_OO_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>the_list</span><span> </span><span class="entity"><span>in_alt_thm_opt</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_OO_Grp_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
      </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.bij_id|fact"><span>bij_id</span></a><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.supp_id_bound|fact"><span>supp_id_bound</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>ORELSE'</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mr_mk_simple_pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_set_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_alt_thm_opt</span></span><span>

    </span><span class="comment1"><span>(*Nonemptiness witnesses*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_wits_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit_thms_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*|&gt; prnttc "wit" ctxt*)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
      map_id0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span class="main"><span>,</span></span><span>
      map_comp0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span class="main"><span>,</span></span><span>
      map_cong0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span class="main"><span>,</span></span><span>
      set_map0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span class="main"><span>,</span></span><span>
      infinite_regular_card_order </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_tac</span></span><span class="main"><span>,</span></span><span>
      set_bd </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span class="main"><span>,</span></span><span>
      le_rel_OO </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span class="main"><span>,</span></span><span>
      in_rel </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span class="main"><span>,</span></span><span>
      pred_set </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span class="main"><span>,</span></span><span>
      wit </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span>
    </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mrbnf_def</span></span><span> </span><span class="entity"><span>Smart_Inline</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Dont_Note</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_simple_class_opt</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span>
        </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mapx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type_sets</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_mrbnf_to_unfolds</span></span><span> </span><span class="entity"><span>mrbnf'</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>permute_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_permute</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cache_comp_simple</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_permute_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_demote_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>targetTs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>targetTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_killN</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>free_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>free</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>bound</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frees_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nwits_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coclass</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>coclass_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*Helper functions*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span>  </span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xs</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ys</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span> </span><span>::</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span class="entity"><span>bs</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span> </span><span>::</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span class="entity"><span>bs</span></span><span>

    </span><span class="comment1"><span>(*Check if all conversions are legal*)</span></span><span>
    </span><span class="comment1"><span>(*Live &gt; Free &gt; Bound &gt; Dead*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Incompat_Var_Types</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>var_leq</span></span><span> </span><span class="entity"><span>Live_Var</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>var_leq</span></span><span> </span><span class="entity"><span>Free_Var</span></span><span> </span><span class="entity"><span>Live_Var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Incompat_Var_Types</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>var_leq</span></span><span> </span><span class="entity"><span>Free_Var</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>var_leq</span></span><span> </span><span class="entity"><span>Bound_Var</span></span><span> </span><span class="entity"><span>Bound_Var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>var_leq</span></span><span> </span><span class="entity"><span>Bound_Var</span></span><span> </span><span class="entity"><span>Dead_Var</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>var_leq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Incompat_Var_Types</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>map2</span><span> </span><span class="entity"><span>var_leq</span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span class="entity"><span>targetTs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="comment1"><span>(*calculate new variable counts*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_live</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_free</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_bound</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cocc</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>targetTs</span></span><span> </span><span>|&gt;</span><span> </span><span>length</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cocc</span></span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>,</span></span><span class="entity"><span>cocc</span></span><span> </span><span class="entity"><span>Free_Var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cocc</span></span><span> </span><span class="entity"><span>Bound_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atargets</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ftargets</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Btargets</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fil_var</span></span><span> </span><span class="entity"><span>var_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>targetTs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fil_var</span></span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fil_var</span></span><span> </span><span class="entity"><span>Free_Var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fil_var</span></span><span> </span><span class="entity"><span>Bound_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_count</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>new_live</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>new_free</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>new_bound</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>new_live</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>isdemot_A</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>not_equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Atargets</span></span><span>

    </span><span class="comment1"><span>(* TODO: check 0 &lt; n &lt;= live *)</span></span><span>
    </span><span class="comment1"><span>(*`f = (f x, x)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>deads</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Live_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>sort</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.type|class"><span>type</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Dead_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>sort</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.type|class"><span>type</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>|</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Atargets</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>demotedAs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>isdemot_A</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>As'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sAs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tlthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_TFrees</span></span><span> </span><span class="entity"><span>new_live</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="entity"><span>demotedAs</span></span><span> </span><span class="entity"><span>sAs'</span></span><span> </span><span class="entity"><span>isdemot_A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tlthy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>names_lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>free</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_sets_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*sets before pruning*)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_dead</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>not_equal</span><span> </span><span class="entity"><span>Dead_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>targetTs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>not_equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>targetTs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_live_old</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>not</span><span> </span><span class="entity"><span>not_live</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_newlive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>not_equal</span><span> </span><span class="entity"><span>Dead_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>targetTs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*length = # of surviving vars*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span> </span><span class="entity"><span>not_dead</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_type_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>targetTs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>not_dead</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Asets</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lives</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>still_lives</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>not</span><span> </span><span class="entity"><span>isdemot_A</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>names_lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>still_lives</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>still_lives</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ABF_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_setT</span></span><span> </span><span>o</span><span> </span><span>range_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>ABF_types</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Dead_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>targetTs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>A'BF_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_setT</span></span><span> </span><span>o</span><span> </span><span>range_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_sets_of_mrbnf</span></span><span>
      </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ABF_living_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>ABF_types</span></span><span> </span><span class="entity"><span>not_dead</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>A'BF_living_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>A'BF_types</span></span><span> </span><span class="entity"><span>not_dead</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ABF_lives</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>ABF_types</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>A'BF_lives</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>A'BF_types</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ABF_living_types</span></span><span> </span><span class="entity"><span>A'BF_living_types</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>killed_ids</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>HOLogic.id_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ABF_types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>not</span><span> </span><span class="entity"><span>not_dead</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="comment1"><span>(* (*Get types of lives, bounds and frees via image of set functions (not permuted)*)
    (*Create term list of permuted sets*)
    val (ABFsets, _(*names_lthy*)) = lthy
      |&gt; mk_Frees "A" (map HOLogic.mk_setT (permute ABF_types));
    val rel = fold_rev Term.absdummy (permute_live (map2 mk_pred2T As As'))
      (Term.list_comb (mk_rel_of_mrbnf Ds As As' Bs Fs mrbnf, unpermute_live (*shorter permutation*) (map Bound (live - 1 downto 0))))
      |&gt; Syntax.check_term lthy (*temporary*);
*)</span></span><span>
    </span><span class="comment1"><span>(*mrbnf.map id ... id*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mapx</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="entity"><span>fs</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span>  </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cond_interlace</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_count</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>killed_ids</span></span><span> </span><span class="entity"><span>not_dead</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="comment1"><span>(*Term.list_comb (mk_map_of_mrbnf Ds As As' Bs Fs mrbnf, map HOLogic.id_const killedAs);*)</span></span><span>

    </span><span class="comment1"><span>(*mrbnf.rel (op =) ... (op =)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>demotedAs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>ABF_lives</span></span><span> </span><span class="entity"><span>isdemot_A</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_lives</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>not</span><span> </span><span class="entity"><span>isdemot_A</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>mk_pred2T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter_lives</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter_lives</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="entity"><span>rs</span></span><span>  </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rel_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>demotedAs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_live</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>isdemot_A</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*mrbnf.pred (%_. True) ... (%_ True)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_lives</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>not</span><span> </span><span class="entity"><span>isdemot_A</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_pred1T</span></span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>filter_lives</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*val pred = Term.list_comb (mk_pred_of_mrbnf Ds As Bs Fs mrbnf,
      map (fn T =&gt; Term.absdummy T @{term True}) killedAs);*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="entity"><span>ps</span></span><span>  </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pred_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.absdummy</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>demotedAs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_live</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>isdemot_A</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bd_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_id0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trans</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>  </span><span>THEN</span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_comp0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>THEN</span><span>
      </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.supp_id_bound|fact"><span>supp_id_bound</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.bij_id|fact"><span>bij_id</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>ORELSE'</span><span>
        </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.id_comp|fact"><span>id_comp</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span>Goal.assume_rule_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>)</span></span><span>
      </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.supp_id_bound|fact"><span>Prelim.supp_id_bound</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
      </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.bij_id|fact"><span>Fun.bij_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.supp_id_bound|fact"><span>Prelim.supp_id_bound</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
        </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.bij_id|fact"><span>Fun.bij_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_map0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>not_dead</span></span><span> </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_infinite_regular_card_order_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_bd_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>not_dead</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mr_kill_in_alt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>ORELSE</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.Collect_cong|fact"><span>Collect_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>iffI</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
      </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>CHANGED</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>etac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conjE</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>CHANGED</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>etac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conjI</span></span><span> </span><span>ORELSE'</span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conjI</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>subset_UNIV</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>subset_UNIV</span></span><span> </span><span>ORELSE'</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
      </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>CHANGED</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>etac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conjE</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>CHANGED</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>etac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conjI</span></span><span> </span><span>ORELSE'</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>ORELSE</span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.UNIV_eq_I|fact"><span>UNIV_eq_I</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>CollectI</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
        </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conjI</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>subset_UNIV</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span> </span><span class="entity"><span>is_live</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*previously: mk_in Asets sets T*)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_UNIV</span></span><span> </span><span class="entity"><span>demotedAs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="entity"><span>isdemot_A</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span>  </span><span class="entity"><span>mrbnf_sets</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>mr_kill_in_alt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>EVERY'</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Orderings.html#Orderings.ord_class.ord_le_eq_trans|fact"><span>ord_le_eq_trans</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le_rel_OO_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Relation.html#Relation.eq_OO|fact"><span>eq_OO</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mr_rel_Grp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mr_rel_Grp_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_cong0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_cong0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_map_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>supp_bij_ass_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>FIRST'</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.supp_id_bound|fact"><span>supp_id_bound</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.bij_id|fact"><span>bij_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
          </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_cong2_tac</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>Subgoal.FOCUS_PARAMS</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span class="main"><span>=</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>split_last</span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>infer_instantiate'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.fun_cong|fact"><span>fun_cong</span></a><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.fun_cong|fact"><span>fun_cong</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>EVERY1</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>fun_cong2_tac</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>in_alt_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.OO_Grp_cong|fact"><span>OO_Grp_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.arg_cong2|fact"><span>arg_cong2</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><span>"</span><span class="keyword1"><a class="entity_ref" href="../../../../../../HOL/HOL/Relation.html#Relation.relcompp|const"><span>(OO)</span></a></span><span>"</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.arg_cong|fact"><span>arg_cong</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../HOL/HOL/Relation.html#Relation.conversep|const"><span>conversep</span></a><span>"</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mr_rel_Grp</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span class="entity"><span>supp_bij_ass_tac</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mr_rel_conversep_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span class="entity"><span>supp_bij_ass_tac</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mr_rel_Grp</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span class="entity"><span>supp_bij_ass_tac</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>fun_cong2_tac</span></span><span class="main"><span>,</span></span><span>
          </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Hilbert_Choice.html#Hilbert_Choice.inv_id|fact"><span>inv_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mr_rel_OO_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span class="entity"><span>supp_bij_ass_tac</span></span><span class="main"><span>,</span></span><span>
          </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.o_id|fact"><span>o_id</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.id_o|fact"><span>id_o</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.Grp_fst_snd|fact"><span>Grp_fst_snd</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Def.html#BNF_Def.eq_alt|fact"><span>eq_alt</span></a><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Relation.html#Relation.conversep_eq|fact"><span>conversep_eq</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Relation.html#Relation.eq_OO|fact"><span>eq_OO</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mr_rel_def_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>meta_eq_to_obj_eq</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>BNF_Util.mk_unabs_def</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>free</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>bound</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.Grp_UNIV_def|fact"><span>Grp_UNIV_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_map</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.id_def|fact"><span>id_def</span></a><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>EqSubst.eqsubst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>map_comp_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          </span><span>REPEAT_DETERM</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.supp_id_bound|fact"><span>supp_id_bound</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.bij_id|fact"><span>bij_id</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>ORELSE'</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.id_o|fact"><span>id_o</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.o_id|fact"><span>o_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span>
        </span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_set_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_wits_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_interlace</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.undefined|const"><span>undefined</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>demotedAs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lives</span></span><span> </span><span class="entity"><span>isdemot_A</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span>absfree</span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>I</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wit</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>I</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf_wits</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit_thms_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
      map_id0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span class="main"><span>,</span></span><span>
      map_comp0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span class="main"><span>,</span></span><span>
      map_cong0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span class="main"><span>,</span></span><span>
      set_map0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span class="main"><span>,</span></span><span>
      infinite_regular_card_order </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_tac</span></span><span class="main"><span>,</span></span><span>
      set_bd </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span class="main"><span>,</span></span><span>
      le_rel_OO </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span class="main"><span>,</span></span><span>
      in_rel </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span class="main"><span>,</span></span><span>
      pred_set </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span class="main"><span>,</span></span><span>
      wit </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span>
    </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mrbnf_def</span></span><span> </span><span class="entity"><span>Smart_Inline</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Dont_Note</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>new_deads</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_simple_class_opt</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span>
        </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mapx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type_sets</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_mrbnf_to_unfolds</span></span><span> </span><span class="entity"><span>mrbnf'</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>demote_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>targetTs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_demote</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>targetTs</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span>&lt;&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>targetTs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cache_comp_simple</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_demote_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>targetTs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Adding dummy variables n1-Lives, n2-Frees, n3-Bounds *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_lift_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>n2</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>n3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(*Read out various attributes of the mrbnf via accessor methods*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_liftN</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>free_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frees_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nwits_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>coclass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>coclass_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>bound</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>free</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newcount</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>n2</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* TODO: check 0 &lt; n, m &lt; 0, l &lt; 0 *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newAs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newAs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newFs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newBs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>deads</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>chop</span><span> </span><span class="entity"><span>n1</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_TFrees</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>live</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>chop</span><span> </span><span class="entity"><span>n1</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_TFrees</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>live</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>chop</span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>chop</span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_TFrees'</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n3</span></span><span> </span><span class="entity"><span>class</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span>Type.sort_of_atyp</span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newVars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>newAs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>newFs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>newBs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newVars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>newAs'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>newFs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>newBs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_sets_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>absdummy</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_set</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>newVars</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_type_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n1</span></span><span> </span><span class="entity"><span>Live_Var</span></span><span> </span><span>@</span><span> </span><span>replicate</span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="entity"><span>Free_Var</span></span><span> </span><span>@</span><span>  </span><span>replicate</span><span> </span><span class="entity"><span>n3</span></span><span> </span><span class="entity"><span>Bound_Var</span></span><span>
      </span><span>@</span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>sets</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Asets</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>range_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sets</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*%f1 ... fn. mrbnf.map*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mapx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>newVars</span></span><span> </span><span class="entity"><span>newVars'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*%Q1 ... Qn. mrbnf.rel*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>mk_pred2T</span></span><span> </span><span class="entity"><span>newAs</span></span><span> </span><span class="entity"><span>newAs'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rel_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*%P1 ... Pn. mrbnf.pred*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_pred1T</span></span><span> </span><span class="entity"><span>newAs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pred_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>Live_Var</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_type_sets</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bd_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_id0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>map_comp0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.comp_assoc|fact"><span>comp_assoc</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.id_comp|fact"><span>id_comp</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.comp_id|fact"><span>comp_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span>THEN</span><span> </span><span>REPEAT_DETERM_N</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>*</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n2</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>free</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>*</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n3</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>bound</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span>THEN</span><span> </span><span>REPEAT_DETERM_N</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newcount</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>count</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Goal.assume_rule_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>replicate</span><span> </span><span class="entity"><span>newcount</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>empty_natural_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_map0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_infinite_regular_card_order_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>replicate</span><span> </span><span class="entity"><span>newcount</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.Cinfinite_gt_empty|fact"><span>Cinfinite_gt_empty</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN'</span><span>
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bd_Cinfinite_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_bd_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt_thm_opt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flt_lives</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>is_live</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>flt_lives</span></span><span> </span><span class="entity"><span>Asets</span></span><span> </span><span class="comment1"><span>(*previously, Asets was used instead of live_sets*)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="entity"><span>live_sets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flt_lives</span></span><span> </span><span class="entity"><span>sets</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_in</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n1</span></span><span> </span><span class="entity"><span>live_sets</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_keep</span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>newcount</span></span><span> </span><span class="entity"><span>is_live</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>live_sets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>in_alt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>NONE</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> prems </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lift_in_alt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le_rel_OO_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mr_mk_simple_rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rel_OO_Grp</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rel_OO_Grp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_alt_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.OO_Grp_cong|fact"><span>OO_Grp_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>the_list</span><span> </span><span class="entity"><span>in_alt_thm_opt</span></span><span class="main"><span>)</span></span><span>
      </span><span>THEN</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_OO_Grp_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
        </span><span>THEN</span><span> </span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mr_mk_simple_pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_set_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_alt_thm_opt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_wits_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_simple_wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit_thms_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
      map_id0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span class="main"><span>,</span></span><span>
      map_comp0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span class="main"><span>,</span></span><span>
      map_cong0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span class="main"><span>,</span></span><span>
      set_map0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_map0_tacs</span></span><span class="main"><span>,</span></span><span>
      infinite_regular_card_order </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_tac</span></span><span class="main"><span>,</span></span><span>
      set_bd </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span class="main"><span>,</span></span><span>
      le_rel_OO </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span class="main"><span>,</span></span><span>
      in_rel </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span class="main"><span>,</span></span><span>
      pred_set </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span class="main"><span>,</span></span><span>
      wit </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span>
    </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mrbnf_def</span></span><span> </span><span class="entity"><span>Smart_Inline</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Dont_Note</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_simple_class_opt</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span>
        </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mapx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type_sets</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_mrbnf_to_unfolds</span></span><span> </span><span class="entity"><span>mrbnf'</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lift_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>ns</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_lift</span></span><span> </span><span class="entity"><span>ns</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cache_comp_simple</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_lift_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>ns</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Composition pipeline *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lift_and_permute_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>ns</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>lift_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>ns</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span>
  </span><span>#&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>permute_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tfree_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fast_string_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term_Ord.sort_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ord</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Table</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tfree_ord</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize_mrbnfs</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>oAs</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>outer_opt</span></span><span> </span><span class="entity"><span>mrbnfs</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oAs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>outer_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oAs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vars.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>var_type'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>var_type_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_type</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>var_type</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>var_type'</span></span><span>
    </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oAs'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span>::</span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="entity"><span>mrbnfs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Vars.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ds</span></span><span> </span><span>~~</span><span> </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>MRBNF_Def.Dead_Var</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>odemote_target_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Vars.lookup</span><span> </span><span class="entity"><span>var_map</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Live_Var</span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>oAs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outer_opt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>outer_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outer_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>apfst</span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>demote_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>odemote_target_types</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>demote_target_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vars.lookup</span><span> </span><span class="entity"><span>var_map</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ass</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inners'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>demote_mrbnf</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>qualify</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>mrbnfs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>demote_target_types</span></span><span> </span><span class="entity"><span>mrbnfs</span></span><span> </span><span class="entity"><span>accum'</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oAs2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Vars.lookup</span><span> </span><span class="entity"><span>var_map</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>var_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Dead_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>oAs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_filter_killed</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Vars.lookup</span><span> </span><span class="entity"><span>var_map</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>Dead_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>Live_Var</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_filter_killed</span></span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>oAs'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ass</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_lifts</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>var_type_ord</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>count_lifts</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>var_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>MRBNF_Def.Live_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MRBNF_Def.Free_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MRBNF_Def.Bound_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n3</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MRBNF_Def.Dead_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n3</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ass'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_filter_killed</span></span><span> </span><span>K</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ass</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kill_poss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span>I</span><span> </span><span>o</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Vars.lookup</span><span> </span><span class="entity"><span>var_map</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>Dead_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
    </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ass</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_oDs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Vars.lookup</span><span> </span><span class="entity"><span>var_map</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Dead_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>oAs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>need_liftss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>get_lifts</span></span><span> </span><span class="entity"><span>Ass'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lift_ns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>count_lifts</span></span><span> </span><span class="entity"><span>need_liftss</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dests</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>Ass'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>As</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>find_indices'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>srcs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>find_indices'</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>append</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>need_liftss</span></span><span> </span><span class="entity"><span>Ass'</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oneed_lifts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>var_type</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>MRBNF_Def.Live_Var</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_lifts</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>oAs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>olift_ns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>count_lifts</span></span><span> </span><span class="entity"><span>oneed_lifts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>odest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>oAs2</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>oneed_lifts</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>osrc</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>oneed_lifts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>oAs2</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>var_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MRBNF_Def.Free_Var</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>var_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>MRBNF_Def.Bound_Var</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>var</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>NONE</span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As'</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>ys</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span>tl</span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span>length</span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outer_opt''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum'''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>outer_opt'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outer_opt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum''</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>outer'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>apfst</span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lift_and_permute_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>mrbnfs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>olift_ns</span></span><span> </span><span class="entity"><span>osrc</span></span><span> </span><span class="entity"><span>odest</span></span><span> </span><span class="entity"><span>outer'</span></span><span> </span><span class="entity"><span>accum''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>kill_poss</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>outer_opt''</span></span><span class="main"><span>,</span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 5</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lift_and_permute_mrbnf</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>qualify</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>mrbnfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>mrbnfs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>lift_ns</span></span><span> </span><span class="entity"><span>srcs</span></span><span> </span><span class="entity"><span>dests</span></span><span> </span><span class="entity"><span>inners'</span></span><span> </span><span class="entity"><span>accum'''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_compose_mrbnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>otfrees</span></span><span> </span><span class="entity"><span>tfreess</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_of_mrbnf</span></span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Term.dest_TFree</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tfreess</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oAs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_option</span></span><span> </span><span>Term.dest_TFree</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>otfrees</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Term.add_tfreesT</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oDs</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Dss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>kill_poss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outer'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inners'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_set'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>normalize_mrbnfs</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>oAs</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>outer</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>oDs</span></span><span> </span><span>@</span><span> </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span>append</span><span> </span><span>oo</span><span> </span><span>curry</span><span> </span><span class="entity"><span>swap</span></span><span> </span><span>oo</span><span> </span><span>map</span><span> </span><span>o</span><span> </span><span>nth</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tfreess</span></span><span> </span><span class="entity"><span>kill_poss</span></span><span> </span><span class="entity"><span>Dss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>cache'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>clean_compose_mrbnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>outer'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inners'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compose_mrbnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>otfrees</span></span><span> </span><span class="entity"><span>tfreess</span></span><span> </span><span class="entity"><span>Xs</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_compose</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="entity"><span>otfrees</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tfreess</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>mrbnf_Ds_As</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf_Ds_As</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>cache_comp</span></span><span> </span><span class="entity"><span>key</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>raw_compose_mrbnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>outer</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>otfrees</span></span><span> </span><span class="entity"><span>tfreess</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Hide the type of the bound (optimization) and unfold the definitions (nicer to the user) *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>absT_info</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>absT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   repT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   abs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   rep</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   abs_inject</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   abs_inverse</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   type_definition</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>morph_absT_info</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>{</span></span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_inverse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>absT </span><span class="main"><span>=</span></span><span> </span><span>Morphism.typ</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span>
   repT </span><span class="main"><span>=</span></span><span> </span><span>Morphism.typ</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span>
   abs </span><span class="main"><span>=</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>abs</span></span><span class="main"><span>,</span></span><span>
   rep </span><span class="main"><span>=</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>rep</span></span><span class="main"><span>,</span></span><span>
   abs_inject </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>abs_inject</span></span><span class="main"><span>,</span></span><span>
   abs_inverse </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>abs_inverse</span></span><span class="main"><span>,</span></span><span>
   type_definition </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_absT</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="entity"><span>repU</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repU</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Term.typ_subst_TVars</span><span> </span><span class="entity"><span>rho</span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Term.TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mk_absT"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repU</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_repT</span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="entity"><span>absU</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>absU</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absU</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>C'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Term.typ_subst_atomic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>repT</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Term.TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mk_repT"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absU</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Term.TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mk_repT"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absU</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_abs_or_rep</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>absU</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.id_bnf|const"><span>BNF_Composition.id_bnf</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.id_bnf|const"><span>BNF_Composition.id_bnf</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absU</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>absU</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_abs_or_rep</span></span><span> </span><span class="entity"><span>getT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>dest_Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>getT</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>abs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Term.subst_atomic_types</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_abs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_abs_or_rep</span></span><span> </span><span>range_type</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_rep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_abs_or_rep</span></span><span> </span><span>domain_type</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maybe_typedef</span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>opt_morphs</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>threshold</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>typedef_threshold</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_setT</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>out_of_line</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>threshold</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Term.size_of_typ</span><span> </span><span class="entity"><span>repT</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>threshold</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>out_of_line</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>typedef</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>opt_morphs</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>{</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_cases</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Typedef.info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_cases</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>repT</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.id_bnf|const"><span>BNF_Composition.id_bnf</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.id_bnf|const"><span>BNF_Composition.id_bnf</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
         </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_definition_id_bnf_UNIV|fact"><span>BNF_Composition.type_definition_id_bnf_UNIV</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
         </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Typedef.html#Typedef.type_definition.Abs_inverse|fact"><span>type_definition.Abs_inverse</span></a><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_definition_id_bnf_UNIV|fact"><span>BNF_Composition.type_definition_id_bnf_UNIV</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
         </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Typedef.html#Typedef.type_definition.Abs_inject|fact"><span>type_definition.Abs_inject</span></a><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_definition_id_bnf_UNIV|fact"><span>BNF_Composition.type_definition_id_bnf_UNIV</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
         </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Typedef.html#Typedef.type_definition.Abs_cases|fact"><span>type_definition.Abs_cases</span></a><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_definition_id_bnf_UNIV|fact"><span>BNF_Composition.type_definition_id_bnf_UNIV</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>seal_mrbnf</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_set</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>all_Ds</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frees_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nwits_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nondead</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>As</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>sort</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.type|class"><span>type</span></a></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Variable.declare_typ</span><span> </span><span class="entity"><span>all_Ds</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>sort</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.type|class"><span>type</span></a></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>Term.dest_TVar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy4</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>Term.dest_TVar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy3</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ps'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="comment1"><span>(*names_lthy*)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>interlace</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>interlace</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"R"</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>mk_pred2T</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Xs</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_pred1T</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repTA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_bind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repTA_tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>repTA</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_TA_params_in_order</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>all_Ds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>interlace</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_TFree</span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_TFree</span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>TA_params</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>all_TA_params_in_order</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>inter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>repTA_tfrees</span></span><span> </span><span class="entity"><span>all_TA_params_in_order</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>TA</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>maybe_typedef</span></span><span> </span><span class="entity"><span>force_out_of_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_bind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TA_params</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_UNIV</span></span><span> </span><span class="entity"><span>repTA</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>EVERY'</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>exI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>UNIV_I</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repTB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_T_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>TB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.typ_subst_atomic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>As</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>TA</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RepA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TA</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>repTA</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RepB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TB</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>repTB</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>AbsA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repTA</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>TA</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>AbsB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>repTB</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>TB</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Abs_inject'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span> </span><span>OF</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.UNIV_I|fact"><span>UNIV_I</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.UNIV_I|fact"><span>UNIV_I</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Abs_inverse'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span> </span><span>OF</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Set.html#Set.UNIV_I|fact"><span>UNIV_I</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>absT_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>absT </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TA</span></span><span class="main"><span>,</span></span><span> repT </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repTA</span></span><span class="main"><span>,</span></span><span> abs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AbsA</span></span><span class="main"><span>,</span></span><span> rep </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RepA</span></span><span class="main"><span>,</span></span><span> abs_inject </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inject'</span></span><span class="main"><span>,</span></span><span>
      abs_inverse </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inverse'</span></span><span class="main"><span>,</span></span><span> type_definition </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absfree</span><span> </span><span class="entity"><span>fs'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AbsB</span></span><span class="main"><span>,</span></span><span>
      </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_map_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RepA</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>~~</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RepA</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>mk_sets_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nondead</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nondead</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nondead</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nondead</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_bd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bd_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absfree</span><span> </span><span class="entity"><span>Rs'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_vimage2p</span></span><span> </span><span class="entity"><span>RepA</span></span><span> </span><span class="entity"><span>RepB</span></span><span> </span><span>$</span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rel_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.absfree</span><span> </span><span class="entity"><span>Ps'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_comp</span></span><span>
      </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pred_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>Bs</span></span><span> </span><span class="entity"><span>Fs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RepA</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*bd may depend only on dead type variables*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_repT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_relT</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>mrbnf_bd</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bdT_bind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>bdTN</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>bd_repT</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>all_Ds</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>bdT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_bd_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_bdT_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_bdT_cases</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>maybe_typedef</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bdT_bind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_UNIV</span></span><span> </span><span class="entity"><span>bd_repT</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>EVERY'</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>exI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>UNIV_I</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf_bd'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>bdT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bd_repT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf_bd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_Card_order_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.ordIso_refl|fact"><span>ordIso_refl</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>bd_infinite_regular_card_order_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_bd'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_dir_image</span></span><span> </span><span class="entity"><span>mrbnf_bd</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs_bd_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_repT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>bdT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Abs_bdT_inj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Abs_inj_thm</span></span><span> </span><span class="entity"><span>Abs_bdT_inject</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Abs_bdT_bij</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Abs_bij_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>Abs_bdT_inj</span></span><span> </span><span class="entity"><span>Abs_bdT_cases</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_ordIso</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.dir_image|fact"><span>dir_image</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Abs_bdT_inj</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_Card_order_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_card_order</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.card_order_dir_image|fact"><span>card_order_dir_image</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Abs_bdT_bij</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_card_order_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_cinfinite</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.Cinfinite_cong|fact"><span>Cinfinite_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_Cinfinite_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>conjunct1</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_regularCard</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Arithmetic.html#BNF_Cardinal_Arithmetic.regularCard_ordIso|fact"><span>regularCard_ordIso</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_Cinfinite_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_regularCard_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.infinite_regular_card_order.intro|fact"><span>infinite_regular_card_order.intro</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span>
            </span><span class="entity"><span>bd_card_order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_cinfinite</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_regularCard</span></span><span>
          </span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf_bd'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_copy_map_id0|fact"><span>type_copy_map_id0</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>map_id0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_copy_map_comp0|fact"><span>type_copy_map_comp0</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>map_comp0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>THEN_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>EVERY1</span><span> </span><span class="main"><span>[</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_copy_map_cong0|fact"><span>type_copy_map_cong0</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cong0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.o_apply|fact"><span>o_apply</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>]</span></span><span> </span><span>THEN</span><span> </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span> </span><span>Goal.assume_rule_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_map0_tac</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_copy_set_map0|fact"><span>type_copy_set_map0</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>THEN_ALL_NEW</span><span>
        </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Wellorder_Constructions.html#BNF_Wellorder_Constructions.ordLess_ordIso_trans|fact"><span>ordLess_ordIso_trans</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>]</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_copy_set_bd|fact"><span>type_copy_set_bd</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_bd_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>le_rel_OO_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.vimage2p_relcompp_mono|fact"><span>vimage2p_relcompp_mono</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs_inverse'</span></span><span> </span><span>::</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Def.html#BNF_Def.vimage2p_def|fact"><span>vimage2p_def</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.o_apply|fact"><span>o_apply</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>OO_cong</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.arg_cong2|fact"><span>arg_cong2</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><span>"</span><span class="keyword1"><a class="entity_ref" href="../../../../../../HOL/HOL/Relation.html#Relation.relcompp|const"><span>(OO)</span></a></span><span>"</span></span><span class="main"><span>,</span></span><span> </span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.fun_cong|fact"><span>fun_cong</span></a><span class="main"><span>,</span></span><span> </span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.fun_cong|fact"><span>fun_cong</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>EVERY1</span><span> </span><span class="main"><span>[</span></span><span>
        </span><span class="entity"><span>Subgoal.FOCUS_PARAMS</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span class="main"><span>=</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>params</span></span><span>
              </span><span>|&gt;</span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>free_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span>
              </span><span>||&gt;&gt;</span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>infer_instantiate'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>
              </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>Rs</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_OO_Grp_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
        </span><span>REPEAT_DETERM</span><span> </span><span>o</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../MRBNF_Composition.html#MRBNF_Composition.Grp_Rep|fact"><span>Grp_Rep</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OO_cong</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.arg_cong|fact"><span>arg_cong</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../HOL/HOL/Relation.html#Relation.conversep|const"><span>conversep</span></a></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../MRBNF_Composition.html#MRBNF_Composition.type_copy_vimage2p_Grp_Rep_id|fact"><span>type_copy_vimage2p_Grp_Rep_id</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>]</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../MRBNF_Composition.html#MRBNF_Composition.type_copy_vimage2p_Grp_Rep_id|fact"><span>type_copy_vimage2p_Grp_Rep_id</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>]</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.vimage2p_relcompp_converse|fact"><span>vimage2p_relcompp_converse</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../MRBNF_Composition.html#MRBNF_Composition.type_definition_id|fact"><span>type_definition_id</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>fun_cong</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>fun_cong</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OO_cong</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.arg_cong|fact"><span>arg_cong</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../HOL/HOL/Relation.html#Relation.conversep|const"><span>conversep</span></a></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
        </span><span>REPEAT_DETERM</span><span> </span><span>o</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>]</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_copy_vimage2p_Grp_Rep|fact"><span>type_copy_vimage2p_Grp_Rep</span></a><span> </span><a class="entity_ref" href="../../../../MRBNF_Composition.html#MRBNF_Composition.type_copy_vimage2p_Grp_Rep_UNIV|fact"><span>type_copy_vimage2p_Grp_Rep_UNIV</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.vimage2p_relcompp_converse|fact"><span>vimage2p_relcompp_converse</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>]</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>fun_cong</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>fun_cong</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span>
      </span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>EVERY1</span><span> </span><span class="main"><span>[</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_set_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.arg_cong|fact"><span>arg_cong</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>λ</span></span><span class="bound"><span>f</span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>f</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.comp|const"><span>∘</span></a></span><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.Ball_comp_iff|fact"><span>Ball_comp_iff</span></a><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.conj_comp_iff|fact"><span>conj_comp_iff</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span> </span><span>ORELSE'</span><span> </span><span>EVERY'</span><span> </span><span class="main"><span>[</span></span><span>
        </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/Fun.html#Fun.comp_def|fact"><span>comp_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span>
      </span><span class="main"><span>]</span></span><span>
    </span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_wits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>I</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>fold</span><span> </span><span>Term.absdummy</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>I</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>AbsA</span></span><span> </span><span>$</span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>I</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>mk_wits_of_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>nwits</span></span><span> </span><span class="entity"><span>Fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_definition</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.type_copy_wit|fact"><span>type_copy_wit</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span class="entity"><span>mk_simple_wit_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>wit_thms_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
      map_id0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_id0_tac</span></span><span class="main"><span>,</span></span><span>
      map_comp0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_comp0_tac</span></span><span class="main"><span>,</span></span><span>
      map_cong0 </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_cong0_tac</span></span><span class="main"><span>,</span></span><span>
      set_map0 </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>set_map0_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_map0_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      infinite_regular_card_order </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bd_infinite_regular_card_order_tac</span></span><span class="main"><span>,</span></span><span>
      set_bd </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_bd_tacs</span></span><span class="main"><span>,</span></span><span>
      le_rel_OO </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>le_rel_OO_tac</span></span><span class="main"><span>,</span></span><span>
      in_rel </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_OO_Grp_tac</span></span><span class="main"><span>,</span></span><span>
      pred_set </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_set_tac</span></span><span class="main"><span>,</span></span><span>
      wit </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wit_tac</span></span><span>
    </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_class</span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Class_Declaration.class</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prfx</span></span><span> </span><span>^</span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span>single</span><span> </span><span>##&gt;</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>##&gt;</span><span> </span><span>Local_Theory.exit_global</span><span> </span><span>|&gt;</span><span> </span><span>Local_Theory.background_theory_result</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_class</span></span><span> </span><span class="inner_quoted"><span>"var_"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_thms_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>covar_large'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Wellorder_Constructions.html#BNF_Wellorder_Constructions.ordIso_ordLeq_trans|fact"><span>ordIso_ordLeq_trans</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Order_Relation.html#BNF_Cardinal_Order_Relation.cardSuc_invar_ordIso|fact"><span>cardSuc_invar_ordIso</span></a><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/HOL.html#HOL.iffD2|fact"><span>iffD2</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.infinite_regular_card_order.Card_order|fact"><span>infinite_regular_card_order.Card_order</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>bd_infinite_regular_card_order</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Prelim/Prelim.html#Prelim.infinite_regular_card_order.Card_order|fact"><span>infinite_regular_card_order.Card_order</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>bd_infinite_regular_card_order_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Wellorder_Constructions.html#BNF_Wellorder_Constructions.ordIso_symmetric|fact"><span>ordIso_symmetric</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>#</span></span><span>covar_large </span><span class="entity"><span>class_thms</span></span><span>
    </span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>coclass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_class</span></span><span> </span><span class="inner_quoted"><span>"covar_"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>coclass_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subclass_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Locale.intro_locales_tac</span></span><span> </span><span class="main"><span>{</span></span><span>strict </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> eager </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Class_Declaration.prove_subclass</span></span><span> </span><span class="entity"><span>subclass_tac</span></span><span> </span><span class="main"><span>(</span></span><span>the_single</span><span> </span><span class="entity"><span>class</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy3</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_large'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Wellorder_Constructions.html#BNF_Wellorder_Constructions.ordIso_ordLeq_trans|fact"><span>ordIso_ordLeq_trans</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Cardinal_Order_Relation.html#BNF_Cardinal_Order_Relation.card_of_cong|fact"><span>card_of_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Wellorder_Constructions.html#BNF_Wellorder_Constructions.ordIso_symmetric|fact"><span>ordIso_symmetric</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>bd_ordIso</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>#</span></span><span>var_large </span><span class="entity"><span>class_thms</span></span><span>
        </span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>class</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_large'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>var_regular </span><span class="entity"><span>class_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>coclass</span></span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>covar_large'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mrbnf_def</span></span><span> </span><span class="entity"><span>Hardly_Inline</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>user_policy</span></span><span> </span><span class="entity"><span>Note_Some</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>tacs</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>all_deads</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>class_thms</span></span><span class="main"><span>)</span></span><span>
        </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span>Binding.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TA</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mrbnf_map</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mrbnf_sets</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mrbnf_bd'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mrbnf_wits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>mrbnf_rel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>mrbnf_pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfolds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../HOL/HOL/BNF_Composition.html#BNF_Composition.id_bnf_apply|fact"><span>id_bnf_apply</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>map_unfolds </span><span class="entity"><span>unfold_set</span></span><span> </span><span>@</span><span> </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>set_unfoldss </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>#</span></span><span>rel_unfolds </span><span class="entity"><span>unfold_set</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mrbnf'</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>morph_mrbnf_defs</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm_morphism</span><span> </span><span class="inner_quoted"><span>"MRBNF"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>unfolds</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_def_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf''</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_defs_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf''</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_def_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf''</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_qualify</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Thm.def_binding</span><span> </span><span>o</span><span> </span><span>Binding.concealed</span><span> </span><span>o</span><span> </span><span>Binding.qualify</span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>mrbnf_b</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prefix_binding</span></span><span> </span><span class="entity"><span>pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.prefix_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pre</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf_b</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def_qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_prefix_binding</span></span><span> </span><span class="entity"><span>mapN</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def_qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_prefix_binding</span></span><span> </span><span class="entity"><span>relN</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_bs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nondead</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>def_qualify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_prefix_binding</span></span><span> </span><span class="entity"><span>setN</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def_qualify</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_prefix_binding</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_setN</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>nondead</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>map_def</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_def</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_bs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>set_defs</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>def</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>noted</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy'</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.notes</span><span> </span><span class="entity"><span>notes</span></span><span>
      </span><span>||&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>repTA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TA</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>register_mrbnf_raw</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>dest_Type</span><span> </span><span class="entity"><span>TA</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>morph_mrbnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>substitute_noted_thm</span></span><span> </span><span class="entity"><span>noted</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf''</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_deads</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absT_info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>BAD_DEAD</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mrbnf_of_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>Ds0</span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ds0</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>DEADID_mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ID_mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Dead_Var</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"var_types may only be Live, Free or Bound, use Ds0 for deads"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>var_type</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qualify'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span>o</span><span> </span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>fst</span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ID'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>demote_mrbnf</span></span><span> </span><span class="entity"><span>qualify'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>var_type</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ID_mrbnf</span></span><span> </span><span class="entity"><span>accum</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ID'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Same variable appears twice in var_types"</span></span><span>
      </span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mrbnf_of_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Unexpected schematic variable"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mrbnf_of_typ</span></span><span> </span><span class="entity"><span>optim</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify'</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>Ds0</span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_bad_dead</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Library.inter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>BAD_DEAD</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ds0</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mrbnf_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>tfrees</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mrbnf_of</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>BNF_Def.bnf_of</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_bnf_as_mrbnf</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mrbnf_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>DEADID_mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span>Term.dest_TFree</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>tfrees</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Library.inter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>a</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>snd</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_TFree</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frees_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lives</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lives_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>interlace</span></span><span> </span><span class="entity"><span>lives</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tvarsT</span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ds_As</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term.typ_subst_TVars</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>tvars'</span></span><span> </span><span>~~</span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>tfrees</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>deads</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mrbnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ds_As</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>namei</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>nonzero_string_of_int</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>qualify'</span></span><span> </span><span>o</span><span> </span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>namei</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>odead</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dead_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>olive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>obound</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ofree</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>free_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>odead</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Us</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Term.dest_Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_T_of_mrbnf</span></span><span> </span><span class="entity"><span>Ds</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>olive</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>obound</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>ofree</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oDs_pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ds</span></span><span>
              </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oAs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>var_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="entity"><span>Live_Var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span>
            </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>var_types_of_mrbnf</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>oDs_pos</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ofree_bound_pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
            </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>oAs</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oDs_pos</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ofree_bound_pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>inners</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Dss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ass</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>split_list</span><span> </span><span>o</span><span> </span><span>split_list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 2</span><span class="antiquote"><span>}</span></span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mrbnf_of_typ</span></span><span> </span><span class="entity"><span>optim</span></span><span> </span><span class="entity"><span>Smart_Inline</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>Ds0</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Xs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>swap</span></span><span> </span><span>o</span><span> </span><span>`</span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>MRBNF_Def.Live_Var</span></span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_types</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Xs</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>compose_mrbnf</span></span><span> </span><span class="entity"><span>const_policy</span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>flatten_tyargs</span></span><span> </span><span class="entity"><span>mrbnf</span></span><span> </span><span class="entity"><span>inners</span></span><span> </span><span class="entity"><span>oDs</span></span><span> </span><span class="entity"><span>Dss</span></span><span> </span><span class="entity"><span>oAs</span></span><span> </span><span class="entity"><span>Ass</span></span><span> </span><span class="entity"><span>Xs'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="entity"><span>check_bad_dead</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>